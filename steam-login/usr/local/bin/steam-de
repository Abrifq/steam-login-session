#!/bin/bash
#STEAM DE - Script for starting Steam at login
#Copyright (C) 2012  Thomaz de Oliveira dos Reis <thor27@gmail.com>
#
#This program is free software; you can redistribute it and/or
#modify it under the terms of the GNU General Public License
#as published by the Free Software Foundation; either version 2
#of the License, or (at your option) any later version.
#
#This program is distributed in the hope that it will be useful,
#but WITHOUT ANY WARRANTY; without even the implied warranty of
#MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#GNU General Public License for more details.
#
#You should have received a copy of the GNU General Public License
#along with this program; if not, write to the Free Software
#Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301, USA.

function stop(){
    #Stop all running steam process
    killall steam.sh
    killall steam
    killall MainThrd
    #If it doesn't stop, force it
    killall -9 steam
    killall -9 steam.sh
    killall -9 MainThrd

}


stop #call stop function


# Start basic window manager and video settings
xfwm4 --replace --daemon --compositor=off
which nvidia-settings && nvidia-settings -l 
which gnome-settings-daemon && gnome-settings-daemon &

#Reset variables
unset prefix
unset parameters
unset program

#Workaround for "team fortress 2" black screen bug
export LANG=C
export LC_NUMERIC=POSIX

#Workaround for issues when using special font configurations
export FONTCONFIG_FILE=/dev/null

#Set correct parameters, if it's hacked mode or normal mode
[ -f /etc/steam-hacked ] && parameters='steam://open/bigpicture' || parameters='-bigpicture'

#Set optirun as prefix if available
which optirun && prefix=optirun

#Set primusrun as prefix if available
which primusrun && prefix=primusrun

#Get full path of steam executable
program=`which steam`

#gnome-terminal &

#Execute STEAM
old_date=`date +%s`
count=0
NUMBER_OF_WINDOWS=`wmctrl -l | wc -l`

$prefix $program $parameters &

while (( $NUMBER_OF_WINDOWS == `wmctrl -l | wc -l` ))
do
   sleep 1
done

NUMBER_OF_WINDOWS_AND_STEAM=`wmctrl -l | wc -l`
GAME_RUNNING=0
WINDOWS_RUNNING_NOW=`wmctrl -l | wc -l` 
while (( $NUMBER_OF_WINDOWS < $WINDOWS_RUNNING_NOW ))
do
  if (( $GAME_RUNNING == 0 )) && (( $WINDOWS_RUNNING_NOW > $NUMBER_OF_WINDOWS_AND_STEAM))
  then
    GAME_RUNNING=1
  elif (( $GAME_RUNNING == 1 )) && (( $WINDOWS_RUNNING_NOW <= $NUMBER_OF_WINDOWS_AND_STEAM))
  then
    GAME_RUNNING=0
    wmctrl -a Steam
  fi
  sleep 1
  WINDOWS_RUNNING_NOW=`wmctrl -l | wc -l` 
done

stop
